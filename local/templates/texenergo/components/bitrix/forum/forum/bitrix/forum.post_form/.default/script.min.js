function AddTags(e){if(e&&e.parentNode){var t=e.parentNode.parentNode.previousSibling,a=e.parentNode.parentNode;BX.show(t),BX.remove(e.parentNode),""===a.innerHTML&&BX.remove(a);for(var o=t.getElementsByTagName("INPUT"),r=0;r<o.length;r++)if("TEXT"==o[r].type.toUpperCase()){CorrectTags(o[r]),o[r].focus();break}}return!1}function CorrectTags(e){BX("TAGS_div_frame")&&(BX("TAGS_div_frame").id=e.id+"_div_frame")}function fTextToNode(e){var t=BX.create("div");return t.innerHTML=e,t.childNodes.length>0?t.childNodes[0]:null}function PostFormAjaxStatus(e){var t,a=BX.findChild(document,{className:"forum-note-box"},!0,!0);if(a)for(t=0;t<a.length;t++)BX.remove(a[t]);var o=BX.findChildren(document,{className:"forum-block-container"},!0);if(o&&!(o.length<1)){var r=o[o.length-1];if(!(e.length<1)){var i=fTextToNode(e);if(i)for(var n=["forum-info-box","forum-header-box","forum-reply-form"],s=r;(s=s.nextSibling)&&s;)if(1==s.nodeType){var l=!1;for(t in n)if(BX.hasClass(s,n[t])){l=!0;break}if(l){s.parentNode.insertBefore(i,s);break}}}}}function PostFormAjaxNavigation(e,t){var a,o=fTextToNode(e);if(o){var r=BX.findChildren(document,{className:"forum-navigation-box"},!0);if(r){for(a=0;a<r.length;a++)r[a].innerHTML=o.innerHTML;window.oForum.page_number=t}}}function SetForumAjaxPostTmp(e){window.forumAjaxPostTmp=e}function fReplaceOrInsertNode(e,t,a,o){var r=null;return BX.type.isDomNode(a)?!BX.type.isDomNode(e)&&!BX.type.isArray(e)&&e.length>0&&!(e=fTextToNode(e))?!1:(BX.type.isDomNode(t)&&(r=t.nextSibling,t.parentNode.removeChild(t)),r||(r=BX.findChild(a,o,!0)),r?r.parentNode.insertBefore(e,r):a.appendChild(e),!0):!1}function fRunScripts(e){var t=BX.processHTML(e,!0);BX.ajax.processScripts(t.SCRIPT,!0)}function PostFormAjaxResponse(e,t){t.BXFormSubmit_save=null;var a=window.forumAjaxPostTmp;if("undefined"==typeof a)return void BX.reload();var o=BX.findChildren(document,{className:"forum-block-inner"},!0);(!o||o.length<1)&&BX.reload();var r,i=o[o.length-1],n=BX.findChild(i,{tagName:"form",className:"forum-form"},!0);if(i=n?n:i,a.status){if(a.allMessages){if(!a.message)return;var s=i.parentNode;BX.remove(i),s.innerHTML+=a.message,a.navigation&&a.pageNumber&&PostFormAjaxNavigation(a.navigation,a.pageNumber),ClearForumPostForm(t),fRunScripts(a.message)}else if("undefined"!=typeof a.message){var l=BX.findChildren(i,{tagName:"table",className:"forum-post-table"},!0);if(l.length>0){var c=l[l.length-1],d=BX.findChild(c,{tagName:"tfoot"},!0);d&&BX.remove(d)}i.innerHTML+=a.message,ClearForumPostForm(t),fRunScripts(a.message)}else if(a.previewMessage){var u=BX.findChild(document,{className:"forum-preview"},!0),m=BX.findChild(document,{className:"forum_post_form"},!0).parentNode;fReplaceOrInsertNode(a.previewMessage,u,m,{className:"forum_post_form"}),PostFormAjaxStatus(""),fRunScripts(a.previewMessage)}a.messageID&&(r=BX("message"+a.messageID))&&r&&BX.scrollToNode(r)}for(var f=t.getElementsByTagName("input"),p=0;p<f.length;p++){var h=f[p];"submit"==h.getAttribute("type")&&(h.disabled=!1)}BX.remove(BX.findChild(t,{attr:{name:"pageNumber"}},!0)),a.statusMessage&&PostFormAjaxStatus(a.statusMessage)}function ClearForumPostForm(e){var t,a=window[e.jsObjName.value];if(a){a.ReInit(""),a.fAutosave&&BX.bind(a.pEditorDocument,"keydown",BX.proxy(a.fAutosave.Init,a.fAutosave));for(var o=0;o<a.arFiles.length;o++)(t=BX("file-doc"+a.arFiles[o]))&&t&&(BX.remove(t),BX.hide(BX("wd-doc"+a.arFiles[o])),BX.remove(BX("filetoupload"+a.arFiles[o])));var r=e["UF_FORUM_MESSAGE_DOC[]"];if(null!==r&&"undefined"!=typeof r){var i=!1,n=!1;do if(e["UF_FORUM_MESSAGE_DOC[]"]){for(e["UF_FORUM_MESSAGE_DOC[]"][0]?n=e["UF_FORUM_MESSAGE_DOC[]"][0]:(n=e["UF_FORUM_MESSAGE_DOC[]"],i=!0),window.wduf_places&&window.wduf_places[n.value]&&(window.wduf_places[n.value]=null);BX("wd-doc"+n.value);)BX.remove(BX("wd-doc"+n.value));BX.remove(n)}else i=!0;while(!i)}}if(BX.type.isDomNode(e)){(t=BX.findChild(document,{className:"forum-preview"},!0))&&t&&BX.remove(t);var s=BX.findChild(e,{tagName:"TR",className:"error-load"},!0,!0),l=null;if(s)for(;(l=s.pop())&&l;)BX.hide(l);var c=null,d=BX.findChild(e,{attr:{name:"captcha_code"}},!0),u=BX.findChild(e,{attr:{name:"captcha_word"}},!0),m=BX.findChild(e,{className:"forum-reply-field-captcha-image"},!0);m&&(c=BX.findChild(m,{tag:"img"})),d&&u&&c&&(u.value="",BX.ajax.getCaptcha(function(e){d.value=e.captcha_sid,c.src="/bitrix/tools/captcha.php?captcha_code="+e.captcha_sid}))}}function ValidateForm(e,t,a){if(e.BXFormSubmit_save)return!0;var o=window[e.jsObjName.value];if("object"!=typeof e||!e.POST_MESSAGE||!o)return!1;"undefined"==typeof window.oForum&&(window.oForum={}),o.SaveContent();var r="",i=o.GetContent(),n=i.length,s=64e3;if(e.TITLE&&e.TITLE.value.length<=0&&(r+=BX.message("no_topic_name")),0>=n?r+=BX.message("no_message"):n>s&&(r+=BX.message("max_len").replace(/\#MAX_LENGTH\#/gi,s).replace(/\#LENGTH\#/gi,n)),""!==r)return alert(r),!1;if(e["FILES[]"]){var l=[],c=BX.type.isDomNode(e["FILES[]"])?e["FILES[]"]:e["FILES[]"][0],d=BX.type.isDomNode(e["FILES[]"])?!1:0;do BX("filetoupload"+c.value)||l.push(BX.adjust(BX.clone(c),{attrs:{name:"FILES_TO_UPLOAD[]",id:"filetoupload"+c.value}})),c=d===!1?!1:d<e["FILES[]"].length?e["FILES[]"][d++]:!1;while(c);for(;l.length>0;)e.appendChild(l.pop())}for(var u=e.getElementsByTagName("input"),m=0;m<u.length;m++){var f=u[m];"submit"==f.getAttribute("type")&&(f.disabled=!0)}if("Y"==a){var p=e;if("undefined"!=typeof window.oForum&&"undefined"!=typeof window.oForum.page_number){var h=BX.findChild(p,{attr:{name:"pageNumber"}});h?h.value=window.oForum.page_number:(h=BX.create("input",{props:{type:"hidden",name:"pageNumber"}}),h.value=window.oForum.page_number,p.appendChild(h))}return setTimeout(function(){BX.ajax.submit(p,function(e){PostFormAjaxResponse(e,p)})},50),!1}return!0}function ShowLastEditReason(e,t){t&&e?BX.show(t):t&&BX.hide(t)}function ShowVote(e){var t=e.parentNode.parentNode;return BX.remove(e.parentNode),""===t.innerHTML&&BX.remove(t),BX.show(BX("vote_params")),!1}function vote_remove_answer(e){if("object"!=typeof e||null===e)return!1;vote_add_answer(e.parentNode.parentNode.parentNode,!0);var t=e.parentNode.parentNode.firstChild,a=/ANS_(\d+)__(\d+)_/i,o=a.exec(t.parentNode.id),r=parseInt(o[1]),i=parseInt(o[2]);return""===t.value||confirm(BX.message("vote_drop_answer_confirm"))?(t.form["ANSWER_DEL["+r+"]["+i+"]"]&&(t.form["ANSWER_DEL["+r+"]["+i+"]"].value="Y"),t.parentNode.parentNode.removeChild(t.parentNode),!1):!1}function vote_add_answer(e,t){if(!e||"object"!=typeof e)return!1;var a=t!==!0?e.parentNode.parentNode:e,o=a.lastChild.previousSibling?/ANS_(\d+)__(\d+)_/i:/addA(\d+)/i,r=o.exec(a.lastChild.previousSibling?a.lastChild.previousSibling.id:e.name),i=parseInt(r[1]),n=parseInt(r[2]);if(window["__fqan"+i]||(window["__fqan"+i]=n+1),t!==!0){n=window["__fqan"+i]++;var s=BX.create("DIV",{html:window.arVoteParams.template_answer.replace(/\#Q\#/g,i).replace(/\#A\#/g,n)});a.insertBefore(s.firstChild,a.lastChild)}return!1}function vote_remove_question(e){if("object"!=typeof e||null===e)return!1;var t=e.parentNode.previousSibling,a=parseInt(t.id.replace("QUESTION_",""));return""===t.value||confirm(BX.message("vote_drop_question_confirm"))?(t.form["QUESTION_DEL["+a+"]"]&&(t.form["QUESTION_DEL["+a+"]"].value="Y"),t.parentNode.parentNode.parentNode.removeChild(t.parentNode.parentNode),!1):!1}function vote_add_question(e,t){window.__fqn||(window.__fqn=parseInt(t)+1),t=window.__fqn++;var a=BX.create("DIV",{html:window.arVoteParams.template_question.replace(/\#Q\#/g,t)});return e.parentNode.insertBefore(a.firstChild,e),!1}function quoteMessageEx(e){var t=GetSelection();if(e=parseInt(e),document.getSelection&&(t=t.replace(/\r\n\r\n/gi,"_newstringhere_").replace(/\r\n/gi," "),t=t.replace(/  /gi,"").replace(/_newstringhere_/gi,"\r\n\r\n")),""!==t?BX.DoNothing():e>0?t=BX("message_text_"+e,!0)?BX("message_text_"+e,!0).innerHTML:"":e.length>0&&(t=e),""!==t){t=t.replace(/[\n|\r]*<br(\s)*(\/)*>/gi,"\n");var a=function(e,t){var a=" ",o=/showWMVPlayer.*?bx_wmv_player.*?file:[\s'"]*([^"']*).*?width:[\s'"]*([^"']*).*?height:[\s'"]*([^'"]*).*?/gi,r=o.exec(t);if(r&&(a="[VIDEO WIDTH="+r[2]+" HEIGHT="+r[3]+"]"+r[1]+"[/VIDEO]")," "==a){var i=/bxPlayerOnload[\s\S]*?[\s'"]*file[\s'"]*:[\s'"]*([^"']*)[\s\S]*?[\s'"]*height[\s'"]*:[\s'"]*([^"']*)[\s\S]*?[\s'"]*width[\s'"]*:[\s'"]*([^"']*)/gi;r=i.exec(t),r&&(a="[VIDEO WIDTH="+r[3]+" HEIGHT="+r[2]+"]"+r[1]+"[/VIDEO]")}return a};t=t.replace(/<script[^>]*>/gi,"").replace(/<\/script[^>]*>/gi,""),t=t.replace(/\001([^\002]*)\002/gi,a),t=t.replace(/<noscript[^>]*>/gi,"").replace(/<\/noscript[^>]*>/gi,""),t=t.replace(/\003([^\004]*)\004/gi," "),t=t.replace(/<table class\=[\"]*forum-quote[\"]*>[^<]*<thead>[^<]*<tr>[^<]*<th>([^<]+)<\/th><\/tr><\/thead>[^<]*<tbody>[^<]*<tr>[^<]*<td>/gi,""),t=t.replace(/<table class\=[\"]*forum-code[\"]*>[^<]*<thead>[^<]*<tr>[^<]*<th>([^<]+)<\/th><\/tr><\/thead>[^<]*<tbody>[^<]*<tr>[^<]*<td>/gi,""),t=t.replace(/<table class\=[\"]*data-table[\"]*>[^<]*<tbody>/gi,""),t=t.replace(/<\/td>[^<]*<\/tr>(<\/tbody>)*<\/table>/gi,""),t=t.replace(/[\r|\n]{2,}([\001|\002])/gi,"\n$1");for(var o=0;o++<50&&(t.search(/\002([^\002\003]*)\003/gi)>=0||t.search(/\001([^\001\003]*)\003/gi)>=0);)t=t.replace(/\002([^\002\003]*)\003/gi,"[CODE]$1[/CODE]").replace(/\001([^\001\003]*)\003/gi,"[QUOTE]$1[/QUOTE]");var r=function(e,t,a){for(var o=new RegExp("([^]*)("+t+")([^]*)","i"),r=new RegExp("((?:)(?:[^]*))("+t+")((?:[^]*)(?:))","i"),i=0;i++<300&&e.search(o)>=0;)e=e.replace(r,"$1"+a+"$3");return e};for(o=0;o++<10&&t.search(/\004([^\004\003]*)\003/gi)>=0;)t=r(t,"<tr>","[TR]"),t=r(t,"</tr>","[/TR]"),t=r(t,"<td>","[TD]"),t=r(t,"</td>","[/TD]"),t=t.replace(/\004([^\004\003]*)\003/gi,"[TABLE]$1[/TD][/TR][/TABLE]");if(t=t.replace(/[\001\002\003\004]/gi,""),t=BX.browser.IsIE()?t.replace(/<img(?:(?:\s+alt\s*=\s*\"?smile([^\"\s]+)\"?)|(?:\s+\w+\s*=\s*[^\s>]*))*>/gi,"$1"):t.replace(/<img(.*?)alt=[\"]*smile([^\"\s]+)[\"]*[^>]*>/gi,"$2"),t=t.replace(/<img(.+?)data-code=\"(.+?)\"(.+?)>/gi,"$2"),t=t.replace(/<a[^>]+href=[\"]([^\"]+)\"[^>]+>([^<]+)<\/a>/gi,"[URL=$1]$2[/URL]").replace(/<a[^>]+href=[\']([^\']+)\'[^>]+>([^<]+)<\/a>/gi,"[URL=$1]$2[/URL]").replace(/<[^>]+>/gi," ").replace(/&lt;/gi,"<").replace(/&gt;/gi,">").replace(/&quot;/gi,'"').replace(/(smile(?=[:;8]))/g,"").replace(/\&shy;/gi,"").replace(/\&nbsp;/gi," "),window.oLHE&&t){var i;if(e>0&&BX("message_block_"+e,!0)&&BX("message_block_"+e,!0).hasAttribute("bx-author-name")&&(i={name:BX("message_block_"+e,!0).getAttribute("bx-author-name"),id:BX("message_block_"+e,!0).getAttribute("bx-author-id")}),"code"==window.oLHE.sEditorMode&&window.oLHE.bBBCode)i=i?i.id>0?"[USER="+i.id+"]"+i.name+"[/USER]":i.name:"",i=""!==i?i+BX.message("author")+"\n":"",window.oLHE.WrapWith("[QUOTE]","[/QUOTE]",i+t);else if("html"==window.oLHE.sEditorMode){i=i?i.id>0?'<span id="'+window.oLHE.SetBxTag(!1,{tag:"postuser",params:{value:i.id}})+'" style="color: #2067B0; border-bottom: 1px dashed #2067B0;">'+i.name.replace(/</gi,"&lt;").replace(/>/gi,"&gt;")+"</span>":"<span>"+i.name.replace(/</gi,"&lt;").replace(/>/gi,"&gt;")+"</span>":"",i=""!==i?i+BX.message("author")+"<br/>":"";var n=window.oLHE.bBBCode?"":' id"='+window.oLHE.SetBxTag(!1,{tag:"quote"})+'"';window.oLHE.InsertHTML('<blockquote class="bx-quote"'+n+">"+i+window.oLHE.ParseContent(t,!0)+"</blockquote><br/>")}return window.oLHE.SetFocus(),BX.defer(window.oLHE.SetFocus,window.oLHE)(),window.oLHE.fAutosave&&BX.bind(window.oLHE.pEditorDocument,"keydown",BX.proxy(window.oLHE.fAutosave.Init,window.oLHE.fAutosave)),!0}}return!1}function reply2author(e){var t="";return e>0&&BX("message_block_"+e,!0)&&BX("message_block_"+e,!0).hasAttribute("bx-author-name")&&(t={name:BX("message_block_"+e,!0).getAttribute("bx-author-name"),id:BX("message_block_"+e,!0).getAttribute("bx-author-id")}),window.oLHE&&t&&("code"==window.oLHE.sEditorMode&&window.oLHE.bBBCode?(t=t.id>0?"[USER="+t.id+"]"+t.name+"[/USER]":t.name,window.oLHE.WrapWith("",", ",t)):"html"==window.oLHE.sEditorMode&&(t=t.id>0?'<span id="'+window.oLHE.SetBxTag(!1,{tag:"postuser",params:{value:t.id}})+'" style="color: #2067B0; border-bottom: 1px dashed #2067B0;">'+t.name.replace(/</gi,"&lt;").replace(/>/gi,"&gt;")+"</span>":"<span>"+t.name.replace(/</gi,"&lt;").replace(/>/gi,"&gt;")+"</span>",window.oLHE.InsertHTML(t+", ")),window.oLHE.SetFocus(),BX.defer(window.oLHE.SetFocus,window.oLHE)()),!1}BX.Forum=BX.Forum?BX.Forum:{},BX.Forum.transliterate=function(e){e.onblur=function(){clearInterval(e.bxfInterval)},e.bxfInterval=setInterval(function(){e.value!=e.bxValue&&(e.bxValue=e.value,BX.translit(e.value,{max_len:70,change_case:"L",replace_space:"-",replace_other:"",delete_repeat_replace:!0,use_google:!0,callback:function(t){e.nextSibling.value=t}}))},500)};var GetSelection=function(){var e="";if("function"==typeof window.getSelection)try{var t=window.getSelection().getRangeAt(0).cloneContents(),a=BX.create("div");a.appendChild(t),e=a.innerHTML}catch(a){}else document.selection&&document.selection.createRange&&(e=document.selection.createRange().htmlText);return e};
