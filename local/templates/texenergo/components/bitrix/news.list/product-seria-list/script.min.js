JCCatalogSection=function(e){if(this.productType=0,this.showQuantity=!0,this.showAbsent=!0,this.secondPict=!1,this.showOldPrice=!1,this.showPercent=!1,this.showSkuProps=!1,this.visual={ID:"",PICT_ID:"",SECOND_PICT_ID:"",QUANTITY_ID:"",QUANTITY_UP_ID:"",QUANTITY_DOWN_ID:"",PRICE_ID:"",DSC_PERC:"",SECOND_DSC_PERC:"",DISPLAY_PROP_DIV:""},this.product={checkQuantity:!1,maxQuantity:0,stepQuantity:1,isDblQuantity:!1,canBuy:!0,canSubscription:!0,name:"",pict:{},id:0},this.defaultPict={pict:null,secondPict:null},this.ajaxPath="",this.checkQuantity=!1,this.maxQuantity=0,this.stepQuantity=1,this.isDblQuantity=!1,this.canBuy=!0,this.canSubscription=!0,this.offers=[],this.offerNum=0,this.treeProps=[],this.obTreeRows=[],this.showCount=[],this.showStart=[],this.selectedValues={},this.obProduct=null,this.obQuantity=null,this.obQuantityUp=null,this.obQuantityDown=null,this.obPict=null,this.obSecondPict=null,this.obPrice=null,this.obTree=null,this.obBuyBtn=null,this.obDscPerc=null,this.obSecondDscPerc=null,this.obSkuProps=null,this.obMeasure=null,this.errorCode=0,"object"==typeof e)switch(this.productType=parseInt(e.PRODUCT_TYPE),this.showQuantity=e.SHOW_QUANTITY,this.showAbsent=e.SHOW_ABSENT,e.SECOND_PICT&&(this.secondPict=!0),e.SHOW_OLD_PRICE&&(this.showOldPrice=!0),e.SHOW_DISCOUNT_PERCENT&&(this.showPercent=!0),e.SHOW_SKU_PROPS&&(this.showSkuProps=!0),this.visual=e.VISUAL,this.ajaxPath=e.AJAX_PATH,this.productType){case 1:case 2:e.PRODUCT&&"object"==typeof e.PRODUCT?(this.showQuantity&&(this.product.checkQuantity=e.PRODUCT.CHECK_QUANTITY,this.product.isDblQuantity=e.PRODUCT.QUANTITY_FLOAT,this.product.checkQuantity&&(this.product.maxQuantity=this.product.isDblQuantity?parseFloat(e.PRODUCT.MAX_QUANTITY):parseInt(e.PRODUCT.MAX_QUANTITY)),this.product.stepQuantity=this.product.isDblQuantity?parseFloat(e.PRODUCT.STEP_QUANTITY):parseInt(e.PRODUCT.STEP_QUANTITY),this.checkQuantity=this.product.checkQuantity,this.isDblQuantity=this.product.isDblQuantity,this.maxQuantity=this.product.maxQuantity,this.stepQuantity=this.product.stepQuantity),this.product.canBuy=e.PRODUCT.CAN_BUY,this.product.canSubscription=e.PRODUCT.SUBSCRIPTION,this.canBuy=this.product.canBuy,this.canSubscription=this.product.canSubscription,this.product.name=e.PRODUCT.NAME,this.product.pict=e.PRODUCT.PICT,this.product.id=e.PRODUCT.ID):this.errorCode=-1;break;case 3:e.OFFERS&&BX.type.isArray(e.OFFERS)?(this.offers=e.OFFERS,this.offerNum=0,e.OFFER_SELECTED&&(this.offerNum=parseInt(e.OFFER_SELECTED)),isNaN(this.offerNum)&&(this.offerNum=0),e.TREE_PROPS&&(this.treeProps=e.TREE_PROPS),e.DEFAULT_PICTURE&&(this.defaultPict.pict=e.DEFAULT_PICTURE.PICTURE,this.defaultPict.secondPict=e.DEFAULT_PICTURE.PICTURE_SECOND)):this.errorCode=-1;break;default:this.errorCode=-1}0==this.errorCode&&BX.ready(BX.delegate(this.Init,this))},JCCatalogSection.prototype.Init=function(){var e=0;if(this.obProduct=BX(this.visual.ID),this.obProduct||(this.errorCode=-1),this.obPict=BX(this.visual.PICT_ID),this.obPict||(this.errorCode=-2),this.secondPict&&this.visual.SECOND_PICT_ID&&(this.obSecondPict=BX(this.visual.SECOND_PICT_ID)),this.obPrice=BX(this.visual.PRICE_ID),this.obPrice||(this.errorCode=-16),this.showQuantity&&this.visual.QUANTITY_ID&&(this.obQuantity=BX(this.visual.QUANTITY_ID),this.obQuantity||(this.errorCode=-32),this.visual.QUANTITY_UP_ID&&(this.obQuantityUp=BX(this.visual.QUANTITY_UP_ID),this.obQuantityUp||(this.errorCode=-64)),this.visual.QUANTITY_DOWN_ID&&(this.obQuantityDown=BX(this.visual.QUANTITY_DOWN_ID),this.obQuantityDown||(this.errorCode=-128))),3==this.productType){if(this.visual.TREE_ID){this.obTree=BX(this.visual.TREE_ID),this.obTree||(this.errorCode=-256);var t=this.visual.TREE_ITEM_ID;for(e=0;e<this.treeProps.length;e++)if(this.obTreeRows[e]={LEFT:BX(t+this.treeProps[e].ID+"_left"),RIGHT:BX(t+this.treeProps[e].ID+"_right"),LIST:BX(t+this.treeProps[e].ID+"_list"),CONT:BX(t+this.treeProps[e].ID+"_cont")},!(this.obTreeRows[e].LEFT&&this.obTreeRows[e].RIGHT&&this.obTreeRows[e].LIST&&this.obTreeRows[e].CONT)){this.errorCode=-512;break}}this.visual.QUANTITY_MEASURE&&(this.obMeasure=BX(this.visual.QUANTITY_MEASURE))}if(this.visual.BUY_ID&&(this.obBuyBtn=BX(this.visual.BUY_ID),!this.obBuyBtn),this.showPercent&&(this.visual.DSC_PERC&&(this.obDscPerc=BX(this.visual.DSC_PERC)),this.secondPict&&this.visual.SECOND_DSC_PERC&&(this.obSecondDscPerc=BX(this.visual.SECOND_DSC_PERC))),this.showSkuProps&&this.visual.DISPLAY_PROP_DIV&&(this.obSkuProps=BX(this.visual.DISPLAY_PROP_DIV)),0==this.errorCode){switch(this.showQuantity&&(BX.bind(this.obQuantityUp,"click",BX.delegate(this.QuantityUp,this)),BX.bind(this.obQuantityDown,"click",BX.delegate(this.QuantityDown,this)),BX.bind(this.obQuantity,"change",BX.delegate(this.QuantityChange,this))),this.productType){case 1:break;case 3:var i=BX.findChildren(this.obTree,{tagName:"li"},!0);if(i&&0<i.length)for(e=0;e<i.length;e++)BX.bind(i[e],"click",BX.delegate(function(e){this.SelectOfferProp(e)},this));for(e=0;e<this.obTreeRows.length;e++)BX.bind(this.obTreeRows[e].LEFT,"click",BX.delegate(function(e){this.RowLeft(e)},this)),BX.bind(this.obTreeRows[e].RIGHT,"click",BX.delegate(function(e){this.RowRight(e)},this));this.SetCurrent()}this.obBuyBtn&&BX.bind(this.obBuyBtn,"click",BX.delegate(this.Basket,this))}},JCCatalogSection.prototype.QuantityUp=function(){var e=0,t=!0;0==this.errorCode&&this.showQuantity&&(e=this.isDblQuantity?parseFloat(this.obQuantity.value):parseInt(this.obQuantity.value),isNaN(e)||(e+=this.stepQuantity,this.checkQuantity&&e>this.maxQuantity&&(t=!1),t&&(this.obQuantity.value=e)))},JCCatalogSection.prototype.QuantityDown=function(){var e=0,t=!0;0==this.errorCode&&this.showQuantity&&(e=this.isDblQuantity?parseFloat(this.obQuantity.value):parseInt(this.obQuantity.value),isNaN(e)||(e-=this.stepQuantity,e<this.stepQuantity&&(t=!1),t&&(this.obQuantity.value=e)))},JCCatalogSection.prototype.QuantityChange=function(){var e=0,t=!0;0==this.errorCode&&this.showQuantity&&(e=this.isDblQuantity?parseFloat(this.obQuantity.value):parseInt(this.obQuantity.value),isNaN(e)?this.obQuantity.value=this.stepQuantity:(this.checkQuantity&&(e>this.maxQuantity?(t=!1,e=this.maxQuantity):e<this.stepQuantity&&(t=!1,e=this.stepQuantity)),t||(this.obQuantity.value=e)))},JCCatalogSection.prototype.QuantitySet=function(e){0==this.errorCode&&(this.canBuy=this.offers[e].CAN_BUY,this.showQuantity&&(this.isDblQuantity=this.offers[e].QUANTITY_FLOAT,this.checkQuantity=this.offers[e].CHECK_QUANTITY,this.maxQuantity=this.isDblQuantity?parseFloat(this.offers[e].MAX_QUANTITY):parseInt(this.offers[e].MAX_QUANTITY),this.stepQuantity=this.isDblQuantity?parseFloat(this.offers[e].STEP_QUANTITY):parseInt(this.offers[e].STEP_QUANTITY),this.obQuantity.value=this.stepQuantity,this.obMeasure&&(this.offers[e].MEASURE?BX.adjust(this.obMeasure,{html:this.offers[e].MEASURE}):BX.adjust(this.obMeasure,{html:""}))))},JCCatalogSection.prototype.SelectOfferProp=function(e){e||(e=window.event);var t=BX.proxy_context;if(t&&t.hasAttribute("data-treevalue")){var a=t.getAttribute("data-treevalue"),o=a.split("_");if(this.SearchOfferPropIndex(o[0],o[1])){var s=BX.findChildren(t.parentNode,{tagName:"li"},!1);if(s&&0<s.length)for(i=0;i<s.length;i++)value=s[i].getAttribute("data-onevalue"),value==o[1]?BX.addClass(s[i],"bx_active"):BX.removeClass(s[i],"bx_active")}}},JCCatalogSection.prototype.SearchOfferPropIndex=function(e,t){for(var i=-1,a=0;a<this.treeProps.length;a++)if(this.treeProps[a].ID==e){i=a;break}if(i>-1){var o={};for(a=0;i>a;a++){var s="PROP_"+this.treeProps[a].ID;o[s]=this.selectedValues[s]}var s="PROP_"+this.treeProps[i].ID,r=this.GetRowValues(o,s);if(!r)return!1;if(!BX.util.in_array(t,r))return!1;for(o[s]=t,a=i+1;a<this.treeProps.length;a++){s="PROP_"+this.treeProps[a].ID;var r=this.GetRowValues(o,s);if(!r)return!1;if(this.showAbsent){var n=[],l=[];l=BX.clone(o,!0);for(var c=0;c<r.length;c++)l[s]=r[c],this.GetCanBuy(l)&&(n[n.length]=r[c])}else var n=r;this.selectedValues[s]&&BX.util.in_array(this.selectedValues[s],n)?o[s]=this.selectedValues[s]:o[s]=n[0],this.UpdateRow(a,o[s],r,n)}this.selectedValues=o,this.ChangeInfo()}return!0},JCCatalogSection.prototype.RowLeft=function(e){e||(e=window.event);var t=BX.proxy_context;if(t&&t.hasAttribute("data-treevalue")){for(var i=t.getAttribute("data-treevalue"),a=-1,o=0;o<this.treeProps.length;o++)if(this.treeProps[o].ID==i){a=o;break}a>-1&&5<this.showCount[a]&&5-this.showStart[a]<this.showCount[a]&&(this.showStart[a]--,BX.adjust(this.obTreeRows[a].LIST,{style:{marginLeft:20*this.showStart[a]+"%"}}))}},JCCatalogSection.prototype.RowRight=function(e){e||(e=window.event);var t=BX.proxy_context;if(t&&t.hasAttribute("data-treevalue")){for(var i=t.getAttribute("data-treevalue"),a=-1,o=0;o<this.treeProps.length;o++)if(this.treeProps[o].ID==i){a=o;break}a>-1&&5<this.showCount[a]&&0>this.showStart[a]&&(this.showStart[a]++,BX.adjust(this.obTreeRows[a].LIST,{style:{marginLeft:20*this.showStart[a]+"%"}}))}},JCCatalogSection.prototype.UpdateRow=function(e,t,i,a){var o,s=0,r=0,n="";if(e>-1&&e<this.obTreeRows.length){var l=BX.findChildren(this.obTreeRows[e].LIST,{tagName:"li"},!1);if(l&&0<l.length){for(r=i.length,n=r>5?100/r+"%":"20%",obData={props:{className:""},style:{width:n}},"E"==this.treeProps[e].TYPE&&(obData.style.paddingTop=n),s=0;s<l.length;s++)o=l[s].getAttribute("data-onevalue"),BX.util.in_array(o,a)?o==t?obData.props.className="bx_active":obData.props.className="":o==t?obData.props.className="bx_active bx_missing":obData.props.className="bx_missing",BX.util.in_array(o,i)?obData.style.display="":obData.style.display="none",BX.adjust(l[s],obData);obData={style:{width:(r>5?20*r:100)+"%",marginLeft:"0%"}},BX.adjust(this.obTreeRows[e].LIST,obData),"E"==this.treeProps[e].TYPE?BX.adjust(this.obTreeRows[e].CONT,{props:{className:r>5?"bx_item_detail_scu full":"bx_item_detail_scu"}}):BX.adjust(this.obTreeRows[e].CONT,{props:{className:r>5?"bx_item_detail_size full":"bx_item_detail_size"}}),r>5?(BX.adjust(this.obTreeRows[e].LEFT,{style:{display:""}}),BX.adjust(this.obTreeRows[e].RIGHT,{style:{display:""}})):(BX.adjust(this.obTreeRows[e].LEFT,{style:{display:"none"}}),BX.adjust(this.obTreeRows[e].RIGHT,{style:{display:"none"}})),this.showCount[e]=r,this.showStart[e]=0}}},JCCatalogSection.prototype.GetRowValues=function(e,t){var i=[],a=!1;if(0==e.length){for(var o=0;o<this.offers.length;o++)BX.util.in_array(this.offers[o].TREE[t],i)||(i[i.length]=this.offers[o].TREE[t]);a=!0}else for(var o=0;o<this.offers.length;o++){var s=!0;for(var r in e)if(e[r]!=this.offers[o].TREE[r]){s=!1;break}s&&(BX.util.in_array(this.offers[o].TREE[t],i)||(i[i.length]=this.offers[o].TREE[t]),a=!0)}return a?i:!1},JCCatalogSection.prototype.GetCanBuy=function(e){for(var t=!1,i=0;i<this.offers.length;i++){var a=!0;for(var o in e)if(e[o]!=this.offers[i].TREE[o]){a=!1;break}if(a&&this.offers[i].CAN_BUY){t=!0;break}}return t},JCCatalogSection.prototype.SetCurrent=function(){for(var e={},t=this.offers[this.offerNum].TREE,i=0;i<this.treeProps.length;i++){var a="PROP_"+this.treeProps[i].ID,o=this.GetRowValues(e,a);if(!o)break;if(BX.util.in_array(t[a],o)?e[a]=t[a]:(e[a]=o[0],this.offerNum=0),this.showAbsent){var s=[],r=[];r=BX.clone(e,!0);for(var n=0;n<o.length;n++)r[a]=o[n],this.GetCanBuy(r)&&(s[s.length]=o[n])}else var s=o;this.UpdateRow(i,e[a],o,s)}this.selectedValues=e,this.ChangeInfo()},JCCatalogSection.prototype.ChangeInfo=function(){for(var e=-1,t=0;t<this.offers.length;t++){var i=!0;for(var a in this.selectedValues)if(this.selectedValues[a]!=this.offers[t].TREE[a]){i=!1;break}if(i){e=t;break}}if(e>-1){if(this.obPict&&(this.offers[e].PREVIEW_PICTURE?BX.adjust(this.obPict,{style:{backgroundImage:"url("+this.offers[e].PREVIEW_PICTURE.SRC+")"}}):BX.adjust(this.obPict,{style:{backgroundImage:"url("+this.defaultPict.pict.SRC+")"}})),this.secondPict&&this.obSecondPict&&(this.offers[e].PREVIEW_PICTURE_SECOND?BX.adjust(this.obSecondPict,{style:{backgroundImage:"url("+this.offers[e].PREVIEW_PICTURE_SECOND.SRC+")"}}):this.offers[e].PREVIEW_PICTURE.SRC?BX.adjust(this.obSecondPict,{style:{backgroundImage:"url("+this.offers[e].PREVIEW_PICTURE.SRC+")"}}):this.defaultPict.secondPict?BX.adjust(this.obSecondPict,{style:{backgroundImage:"url("+this.defaultPict.secondPict.SRC+")"}}):BX.adjust(this.obSecondPict,{style:{backgroundImage:"url("+this.defaultPict.pict.SRC+")"}})),this.showSkuProps&&this.obSkuProps&&(0==this.offers[e].DISPLAY_PROPERTIES.length?BX.adjust(this.obSkuProps,{style:{display:"none"},html:""}):BX.adjust(this.obSkuProps,{style:{display:""},html:this.offers[e].DISPLAY_PROPERTIES})),this.obPrice){var o=this.offers[e].PRICE.PRINT_DISCOUNT_VALUE;if(this.showOldPrice&&this.offers[e].PRICE.DISCOUNT_VALUE!=this.offers[e].PRICE.VALUE&&(o+=" <span>"+this.offers[e].PRICE.PRINT_VALUE+"</span>"),BX.adjust(this.obPrice,{html:o}),this.showPercent){if(this.offers[e].PRICE.DISCOUNT_VALUE!=this.offers[e].PRICE.VALUE)var s={style:{display:""},html:this.offers[e].PRICE.DISCOUNT_DIFF_PERCENT};else var s={style:{display:"none"},html:""};this.obDscPerc&&BX.adjust(this.obDscPerc,s),this.obSecondDscPerc&&BX.adjust(this.obSecondDscPerc,s)}}this.offerNum=e,this.showQuantity&&this.QuantitySet(this.offerNum)}},JCCatalogSection.prototype.Basket=function(){if(this.canBuy){var e={sessid:BX.bitrix_sessid(),action:"ADD2BASKET",ajax_basket:"Y"};switch(this.productType){case 1:case 2:e.id=this.product.id,this.showQuantity&&(e.quantity=this.obQuantity.value);break;case 3:e.id=this.offers[this.offerNum].ID,this.showQuantity&&(e.quantity=this.obQuantity.value);break;default:return}BX.ajax.loadJSON(this.ajaxPath,e,BX.delegate(this.ShowBasketPopup,this))}},JCCatalogSection.prototype.ShowBasketPopup=function(e){var t="";if("object"==typeof e&&"OK"==e.STATUS){switch(strName="",strPict="",this.productType){case 1:case 2:strName=this.product.name,strPict=this.product.pict.SRC;break;case 3:strName=this.offers[this.offerNum].NAME,strPict=this.offers[this.offerNum].PREVIEW_PICTURE.SRC}t="<p>"+BX.message("ADD_TO_BASKET_OK")+"</p>",t+='<img src="'+strPict+'" height="130"><p>'+strName+"</p>"}var i=BX.PopupWindowManager.create("CatalogSectionBasket"+this.visual.ID,null,{autoHide:!1,offsetLeft:0,offsetTop:0,overlay:!0,draggable:{restrict:!0},closeByEsc:!0,closeIcon:{right:"12px",top:"10px"},content:'<div style="width:300px;text-align: center;padding-top:5px; margin-bottom: 10px;">'+t+'<a class="bx_bt_blue bx_medium" href="'+BX.message("setButtonBuyUrl")+'"><span class="bx_icon_cart"></span><span>'+BX.message("setButtonBuyName")+"</span></a></div>"});i.show()};
