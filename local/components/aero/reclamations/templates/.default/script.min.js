$(function(){function haveProducts(){var t=!1;return $(".prod-list .cartItem").each(function(){var e=$(this).attr("prod_id"),a=$(this).attr("realiz_id");return e.length>0&&a.length>0?(t=!0,!0):void 0}),t}function handleSearchResponse(data){if(realization=eval(data),realization.length>0){$("#no_products_msg").hide(),realization=realization[0];var rNum=realization.REALIZ_NUM,rDate=realization.PROPERTY_DATE_VALUE;for(i=0;i<realization.PROPERTY_BASKET_ITEMS_VALUE.length;i++)product=realization.PROPERTY_BASKET_ITEMS_VALUE[i],productAdded(rNum,product)||(sampleSelector="#sample_return_item",listSelector=".prod-list-wrap",addProductToList(rNum,rDate,product,sampleSelector,listSelector),sampleSelector="#sample_return_item_sn",listSelector=".sn-wrap",addProductToList(rNum,rDate,product,sampleSelector,listSelector))}else $("#no_products_msg").show()}function productAdded(t,e){var a=!1;return $(".prod-list-wrap .cartItem").each(function(){var i=$(this).attr("prod_id"),r=$(this).attr("realiz_id");return i==e.ID&&r==t?(a=!0,!1):void 0}),a}function addProductToList(t,e,a,i,r){var n=a.PRODUCT_INFO,o=$(i).clone();o.css("display","block"),o.removeAttr("id"),o.attr("realiz_id",t),o.attr("prod_id",n.ID),o.find(".replace_href").attr("href",n.DETAIL_PAGE_URL),"#"==n.DETAIL_PAGE_URL&&(o.find(".replace_href").click(function(t){t.preventDefault()}),o.find(".replace_href").css("cursor","default").css("text-decoration","none")),o.find(".replace_bg").css("background-image",'url("'+n.PICTURE+'")'),o.find(".replace_name").text(n.NAME),o.find(".replace_sku").text(n.PROPERTY_SKU_VALUE),o.find(".replace_realize_num").text(t),o.find(".replace_realize_date").text(e),a.QUANTITY.length>0&&o.find(".replace_quantity").text(a.QUANTITY+" шт."),o.find(".replace_product_id").val(a.ID),o.find(".replace_product_id").attr("name","products["+t+"][]"),o.find(".replace_product_name").val(n.NAME),o.find(".replace_product_name").attr("name","products_name["+t+"]["+a.ID+"]"),o.find(".replace_quantity_new").removeClass("field-error").attr("id","").attr("name","quantity["+t+"]["+a.ID+"]"),o.find(".replace_serial").attr("name","serial["+t+"]["+a.ID+"][]"),$(r).append(o)}var ajaxUrl="/local/components/aero/reclamations/ajax/",lastProdId=1;$("#attach_description").click(function(){return $("#description_file").trigger("click"),!1}),$("#description_file").change(function(){$(this).prev(".filename").text($(this).val())}),$(".submit_reclamation").click(function(){$("input[name=realize_number]").removeClass("field-error");var t=!1;if(haveProducts()&&(t=!0,$("#type_peresort").is(":checked"))){var e=$("input[name=realize_number]").val();0==e.length&&($("input[name=realize_number]").addClass("field-error"),t=!1)}return t&&$("#reclamation_form").submit(),!1}),$(".reclBlock").click(function(t){t.preventDefault(),$(".b-reclBlock").removeClass("active"),$(".type-boxes input").attr("checked",!1),$(".b-reclBlock",this).addClass("active");var e=$(this).attr("type_id");$("#"+e).attr("checked",!0),"type_peresort"==e?$("#add_new_product").show():$("#add_new_product").hide();var a=$(this).attr("need_sn"),i=$(this).attr("quantity_caption");$("#q-caption").text(i),"y"==a?$(".s-num").show():($(".s-num").hide(),$(".sn-wrap .replace_serial").val(""))}),$("#reclamation_form").on("keyup",".replace_quantity_new",function(){var t=$(this).val().replace(/[^\d+]/g,""),e=$(".type-boxes input:checked").val();if("peresort"!=e){var a=parseInt($(this).closest("tr").find(".replace_quantity").text());t>a&&(t=a)}$(this).val(t)}),$("#reclamation_form").on("click",".close-item",function(t){t.preventDefault();var e=$(this).closest(".cartItem"),a=e.attr("realiz_id"),i=e.attr("prod_id");$(".sn-wrap .s-num-item-wrap").each(function(){var t=$(this).attr("realiz_id"),e=$(this).attr("prod_id");return a==t&&i==e?($(this).remove(),!1):void 0}),e.remove()}),$("#reclamation_form").on("click",".add-sn",function(t){t.preventDefault();var e=$(this).prev(".item").clone(),a=parseInt($(e).find(".num").text());a++,$(e).find(".num").text(a),e.find(".cartForm-input").val(""),$(this).before(e)}),$("#add_single_product").click(function(t){t.preventDefault();var e=$("input[name=new_product_name]").val();if($("input[name=new_product_name]").val(""),e.length>0){var a={QUANTITY:"",ID:"-"+lastProdId,PRODUCT_INFO:{ID:"-"+lastProdId,PICTURE:"/local/templates/texenergo/img/catalog/no-image.png",DETAIL_PAGE_URL:"#",PROPERTY_SKU_VALUE:"",NAME:e}};addProductToList("-","-",a,"#sample_return_item",".prod-list-wrap"),lastProdId++}}),$("#add_products").click(function(t){t.preventDefault();var e=$("input[name=realize_number]").val();e.length>0&&($(".prod-list-wrap .cartItem ").each(function(){var t=$(this).attr("realiz_id");"-"!=t&&$(this).remove()}),$(".sn-wrap").html(""),$.post(ajaxUrl+"search_product.php",{r_num:e},function(t){handleSearchResponse(t)}))}),$(".pick-sn").click(function(){$(this).hasClass("subSwitch-on")?($(this).removeClass("subSwitch-on"),$(".sn-wrap").hide()):($(this).addClass("subSwitch-on"),$(".sn-wrap").show())})});
